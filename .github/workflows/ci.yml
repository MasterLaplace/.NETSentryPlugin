# ============================================================================
# GitHub Actions CI/CD Pipeline for MySentry.Plugin
# ============================================================================
# Alternative to GitLab CI for GitHub users
#
# Required Repository Secrets (Settings > Secrets and variables > Actions):
# - SENTRY_AUTH_TOKEN: Sentry authentication token
# - SENTRY_ORG: Sentry organization slug
# - SENTRY_PROJECT: Sentry project slug
# - SENTRY_DSN: Sentry DSN for the application
# - NUGET_API_KEY: NuGet API key for package publishing (optional)
# ============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'           # Standard tags: v1.0.0
      - 'plugin-v*'    # Plugin-specific: plugin-v1.0.0
      - 'testapp-v*'   # TestApp-specific: testapp-v1.0.0
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: false
        type: string
      create_sentry_release:
        description: 'Create Sentry release'
        required: false
        default: true
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_FILE: 'mysentryapp.sln'
  PLUGIN_PROJECT: 'src/MySentry.Plugin/MySentry.Plugin.csproj'
  TEST_PROJECT: 'tests/MySentry.Plugin.Tests/MySentry.Plugin.Tests.csproj'

jobs:
  # ============================================================================
  # Build Job
  # ============================================================================
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for Sentry commit association

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Determine version
        id: version
        run: |
          # Priority: 1) Manual input, 2) Tag, 3) Read from csproj, 4) Fallback to ci version
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            # Manual workflow_dispatch with version input
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "Using manual version: ${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Standard tag: v1.0.0 -> 1.0.0
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/plugin-v* ]]; then
            # Plugin-prefixed tag: plugin-v1.0.0 -> 1.0.0
            echo "version=${GITHUB_REF#refs/tags/plugin-v}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/testapp-v* ]]; then
            # TestApp-prefixed tag: testapp-v1.0.0 -> 1.0.0
            VERSION=${GITHUB_REF#refs/tags/testapp-v}
            echo "version=MySentry.TestApp@${VERSION}" >> $GITHUB_OUTPUT
          else
            # Try to read version from Plugin csproj
            CSPROJ_VERSION=$(grep -oP '(?<=<Version>)[^<]+' src/MySentry.Plugin/MySentry.Plugin.csproj 2>/dev/null || echo "")
            if [[ -n "$CSPROJ_VERSION" ]]; then
              SHORT_SHA=${GITHUB_SHA:0:7}
              echo "version=${CSPROJ_VERSION}-ci.${SHORT_SHA}" >> $GITHUB_OUTPUT
              echo "Using csproj version with SHA: ${CSPROJ_VERSION}-ci.${SHORT_SHA}"
            else
              # Ultimate fallback
              SHORT_SHA=${GITHUB_SHA:0:7}
              echo "version=0.0.0-ci.${SHORT_SHA}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build
        run: |
          dotnet build ${{ env.SOLUTION_FILE }} \
            --configuration Release \
            --no-restore \
            -p:Version=${{ steps.version.outputs.version }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            src/MySentry.Plugin/bin/Release/
            src/MySentry.TestApp/bin/Release/

  # ============================================================================
  # Test Job
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

      - name: Run tests
        run: |
          dotnet test ${{ env.TEST_PROJECT }} \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --logger "trx;LogFileName=test-results.trx" \
            --collect:"XPlat Code Coverage"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/test-results.trx
            **/coverage.cobertura.xml

      - name: Code coverage report
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: '**/coverage.cobertura.xml'
          fail_ci_if_error: false

  # ============================================================================
  # Sentry Release Job
  # ============================================================================
  sentry-release:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Install Sentry CLI
        run: |
          curl -sL https://sentry.io/get-cli/ | bash

      - name: Create Sentry release
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_URL: ${{ secrets.SENTRY_URL }}
        run: |
          VERSION=${{ needs.build.outputs.version }}

          echo "Creating Sentry release: $VERSION (using SENTRY_URL=${SENTRY_URL:-https://sentry.io})"

          # Basic validation — skip release when secrets are missing
          if [ -z "${SENTRY_AUTH_TOKEN}" ] || [ -z "${SENTRY_ORG}" ]; then
            echo "WARNING: SENTRY_AUTH_TOKEN and/or SENTRY_ORG not set in repository secrets. Skipping Sentry release." >&2
            echo "To enable releases, add the secrets SENTRY_AUTH_TOKEN and SENTRY_ORG (and optionally SENTRY_PROJECT and SENTRY_URL) in Settings → Secrets and variables → Actions."
            exit 0
          fi

          # Debug: print sentry-cli version and try to contact the org (non-fatal)
          sentry-cli --version || true
          if [ -n "${SENTRY_URL}" ]; then
            sentry-cli --url "${SENTRY_URL}" info --org "${SENTRY_ORG}" --debug || true
          else
            sentry-cli info --org "${SENTRY_ORG}" --debug || true
          fi

          # Helper to pass --url only when SENTRY_URL provided
          SENTRY_CLI_URL_PARAM=""
          if [ -n "${SENTRY_URL}" ]; then
            SENTRY_CLI_URL_PARAM="--url ${SENTRY_URL}"
          fi

          # Create release
          sentry-cli ${SENTRY_CLI_URL_PARAM} releases new $VERSION

          # Associate commits
          sentry-cli ${SENTRY_CLI_URL_PARAM} releases set-commits $VERSION --auto

          # Upload debug files (allow failure)
          sentry-cli ${SENTRY_CLI_URL_PARAM} debug-files upload \
            --include-sources \
            ./src/MySentry.Plugin/bin/Release/ || true

          # Finalize release
          sentry-cli ${SENTRY_CLI_URL_PARAM} releases finalize $VERSION

          echo "Sentry release $VERSION created successfully"
  # ============================================================================
  # Deploy Jobs (DISABLED - placeholder templates)
  # ============================================================================
  # These jobs are templates. To enable real deployments:
  # 1. Configure your deployment target (Azure, AWS, GitHub Pages, etc.)
  # 2. Uncomment and customize the steps below
  # 3. Update the environment URLs
  #
  # deploy-staging:
  #   runs-on: ubuntu-latest
  #   needs: [build, test, sentry-release]
  #   if: github.ref == 'refs/heads/main'
  #   environment:
  #     name: staging
  #     url: https://your-staging-url.com
  #   steps:
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: build-output
  #     - name: Deploy to staging
  #       run: |
  #         echo "Add your deployment commands here"
  #
  # deploy-production:
  #   runs-on: ubuntu-latest
  #   needs: [build, test, sentry-release, deploy-staging]
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   environment:
  #     name: production
  #     url: https://your-production-url.com
  #   steps:
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: build-output
  #     - name: Deploy to production
  #       run: |
  #         echo "Add your deployment commands here"

  # ============================================================================
  # NuGet Publish Job
  # ============================================================================
  publish-nuget:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build
        run: dotnet build ${{ env.PLUGIN_PROJECT }} --configuration Release --no-restore

      - name: Pack NuGet package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          dotnet pack ${{ env.PLUGIN_PROJECT }} \
            --configuration Release \
            --no-build \
            -p:PackageVersion=$VERSION \
            -o ./nupkg

      - name: Publish to NuGet
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --api-key $NUGET_API_KEY \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
